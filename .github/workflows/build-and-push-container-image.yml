name: Build and Push Container Image

on:
  workflow_run:
    workflows: ["Maven Package"]
    types:
      - completed
    branches:
      - main
      - '*'

  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v3

    - name: Set up Java for accessing GitHub Packages
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Log in to the Container registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event.inputs.version }}" != "" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
            VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)-pr-${PR_NUMBER}
            echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          else             
            echo "VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Download JAR from GitHub Packages
      run: |
        # Create Maven settings with GitHub authentication and repository configuration
        mkdir -p ~/.m2
        echo "<settings>
          <servers>
            <server>
              <id>github</id>
              <username>${{ github.actor }}</username>
              <password>${{ secrets.GITHUB_TOKEN }}</password>
            </server>
          </servers>
          <profiles>
            <profile>
              <id>github</id>
              <repositories>
                <repository>
                  <id>github</id>
                  <url>https://maven.pkg.github.com/${{ github.repository }}</url>
                  <snapshots>
                    <enabled>true</enabled>
                  </snapshots>
                </repository>
              </repositories>
            </profile>
          </profiles>
          <activeProfiles>
            <activeProfile>github</activeProfile>
          </activeProfiles>
        </settings>" > ~/.m2/settings.xml
        
        # Download the artifact from GitHub Packages
        mvn dependency:copy \
          -Dartifact=com.college:college-schedule:${VERSION} \
          -DoutputDirectory=./build \
          -B

        # Copy the JAR to the right location for Docker build
        cp ./build/college-schedule-${VERSION}.jar ./build/app.jar

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
          context: ./build
          push: true
          tags: ghcr.io/${{ github.repository }}/college-schedule-app:${VERSION}
