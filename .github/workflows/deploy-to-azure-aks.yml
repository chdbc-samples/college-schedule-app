name: Deploy to Azure AKS

on:
  workflow_dispatch:
    inputs:
      version:
        description: '–í–µ—Ä—Å—ñ—è –ø—Ä–æ–≥—Ä–∞–º–∏ –¥–ª—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è'
        required: true
        default: '0.3.0-SNAPSHOT'
        type: string

env:
  AZURE_RESOURCE_GROUP: library-rg
  AKS_CLUSTER_NAME: library-aks
  CONTAINER_REGISTRY: ghcr.io
  IMAGE_NAME: library-app

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–¥—É
        uses: actions/checkout@v4
        
      - name: –í—Ö—ñ–¥ –≤ Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: –û—Ç—Ä–∏–º–∞–Ω–Ω—è –æ–±–ª—ñ–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö AKS
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–±–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ–∫—Ä–µ—Ç—É –¥–ª—è GHCR
        run: |
          echo "Creating/updating GHCR pull secret..."
          
          # –í–∏–¥–∞–ª—è—î–º–æ —ñ—Å–Ω—É—é—á–∏–π secret —è–∫—â–æ —î
          kubectl delete secret ghcr-secret --ignore-not-found=true
          
          # –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π secret –¥–ª—è GHCR
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=${{ env.CONTAINER_REGISTRY }} \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }}
          
          echo "‚úÖ GHCR pull secret created successfully"

      - name: –ó–∞–º—ñ–Ω–∞ —Ç–µ–≥—ñ–≤ –æ–±—Ä–∞–∑—ñ–≤ —É –º–∞–Ω—ñ—Ñ–µ—Å—Ç–∞—Ö Kubernetes
        run: |
          echo "Replacing image tags in manifests..."
          
          # –ó–∞–º—ñ–Ω—é—î–º–æ —Ç–µ–≥ –æ–±—Ä–∞–∑—É –≤ deployment —Ñ–∞–π–ª–∞—Ö
          sed -i "s|{{IMAGE_TAG}}|${{ github.event.inputs.version }}|g" deploy/k8s-manifests/app-deployment.yml
          sed -i "s|{{GITHUB_OWNER}}|${{ github.repository_owner }}|g" deploy/k8s-manifests/app-deployment.yml

          # –ü–æ–∫–∞–∑—É—î–º–æ —â–æ –∑–∞–º—ñ–Ω–∏–ª–∏
          echo "Final image reference:"
          grep "image:" deploy/k8s-manifests/app-deployment.yml

          # –ü–æ–∫–∞–∑—É—î–º–æ –≤–µ—Å—å —Ñ–∞–π–ª –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
          echo "Final deployment manifest:" 
          cat deploy/k8s-manifests/app-deployment.yml

      - name: –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è PostgreSQL
        run: |
          echo "Deploying PostgreSQL..."
          kubectl apply -f deploy/k8s-manifests/postgres-deployment.yml
          
          # –ß–µ–∫–∞—î–º–æ, –ø–æ–∫–∏ PostgreSQL –±—É–¥–µ –≥–æ—Ç–æ–≤–∏–π
          echo "Waiting for PostgreSQL to be ready..."
          kubectl wait --for=condition=ready pod -l app=postgres --timeout=300s
          
          echo "‚úÖ PostgreSQL is ready"

      - name: –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–∞
        run: |
          echo "Deploying application..."
          
          # –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–µ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è
          kubectl delete deployment library-app --ignore-not-found=true
          
          # –ß–µ–∫–∞—î–º–æ –ø–æ–∫–∏ –ø–æ–¥–∏ –∑–Ω–∏–∫–Ω—É—Ç—å
          kubectl wait --for=delete pod -l app=library-app --timeout=120s || true
          
          # –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –Ω–æ–≤–µ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è
          kubectl apply -f deploy/k8s-manifests/app-deployment.yml

          # –ß–µ–∫–∞—î–º–æ, –ø–æ–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–∞ –±—É–¥–µ –≥–æ—Ç–æ–≤–∞
          echo "Waiting for application to be ready..."
          kubectl wait --for=condition=ready pod -l app=library-app --timeout=600s
          
          echo "‚úÖ Application is ready"

      - name: –û—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —Å–µ—Ä–≤—ñ—Å–∏
        run: |
          echo "Getting service information..."
          echo ""
          echo "=== –ü–æ–¥–∏ ==="
          kubectl get pods -o wide
          echo ""
          echo "=== –°–µ—Ä–≤—ñ—Å–∏ ==="
          kubectl get services
          echo ""
          echo "=== –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è ==="
          kubectl get deployments
          
          # –û—Ç—Ä–∏–º—É—î–º–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π IP
          EXTERNAL_IP=$(kubectl get service library-app --output jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          if [ -n "$EXTERNAL_IP" ] && [ "$EXTERNAL_IP" != "null" ]; then
            echo ""
            echo "üåê URL –ø—Ä–æ–≥—Ä–∞–º–∏: http://$EXTERNAL_IP"
          else
            echo ""
            echo "‚è≥ External IP not assigned yet, will check in health check step..."
          fi

      - name: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤'—è –ø—Ä–æ–≥—Ä–∞–º–∏
        run: |
          echo "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤'—è –ø—Ä–æ–≥—Ä–∞–º–∏..."
          
          # –ß–µ–∫–∞—î–º–æ, –ø–æ–∫–∏ –∑'—è–≤–∏—Ç—å—Å—è –∑–æ–≤–Ω—ñ—à–Ω—ñ–π IP
          for i in {1..30}; do
            EXTERNAL_IP=$(kubectl get service library-app --output jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [ -n "$EXTERNAL_IP" ] && [ "$EXTERNAL_IP" != "null" ]; then
              echo "‚úÖ –ó–æ–≤–Ω—ñ—à–Ω—ñ–π IP –∑–Ω–∞–π–¥–µ–Ω–æ: $EXTERNAL_IP"
              echo "üåê URL –ø—Ä–æ–≥—Ä–∞–º–∏: http://$EXTERNAL_IP"
              
              # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å –ø—Ä–æ–≥—Ä–∞–º–∏
              echo "–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –ø—Ä–æ–≥—Ä–∞–º–æ—é..."
              if curl --fail --silent --show-error --max-time 30 "http://$EXTERNAL_IP/" > /dev/null 2>&1; then
                echo "‚úÖ –ü—Ä–æ–≥—Ä–∞–º–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î!"
              else
                echo "‚ö†Ô∏è  –ü—Ä–æ–≥—Ä–∞–º–∞ —â–µ –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î, –∞–ª–µ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
              fi
              break
            fi
            echo "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ IP... (—Å–ø—Ä–æ–±–∞ $i/30)"
            sleep 10
          done
          
          if [ -z "$EXTERNAL_IP" ] || [ "$EXTERNAL_IP" == "null" ]; then
            echo "‚ö†Ô∏è  –ó–æ–≤–Ω—ñ—à–Ω—ñ–π IP –Ω–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –ø—ñ—Å–ª—è 5 —Ö–≤–∏–ª–∏–Ω"
            echo "–ú–æ–∂–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ –∫–æ–º–∞–Ω–¥–æ—é: kubectl get service library-app"
          fi

      - name: –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è
        if: always()
        run: |
          echo ""
          echo "=== –ü—ñ–¥—Å—É–º–æ–∫ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è ==="
          echo "–í–µ—Ä—Å—ñ—è: ${{ github.event.inputs.version }}"
          echo "–û–±—Ä–∞–∑: ${{ env.CONTAINER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.version }}"
          echo ""
          echo "=== –°—Ç–∞—Ç—É—Å –ø–æ–¥—ñ–≤ ==="
          kubectl get pods -l app=library-app -o wide
          echo ""
          echo "=== –õ–æ–≥–∏ –ø–æ–¥—ñ–≤ (–æ—Å—Ç–∞–Ω–Ω—ñ 10 —Ä—è–¥–∫—ñ–≤) ==="
          kubectl logs -l app=library-app --tail=10 || echo "–õ–æ–≥–∏ —â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ"
          echo ""
          echo "=== –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤—ñ—Å—É ==="
          kubectl get service library-app
          echo ""
          echo "=== –°—Ç–∞—Ç—É—Å —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è ==="
          kubectl get deployment library-app
          echo ""
          
          # –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–¥—ñ—ó —è–∫—â–æ —î –ø—Ä–æ–±–ª–µ–º–∏
          if ! kubectl get pods -l app=library-app --no-headers | grep -q "Running"; then
            echo "=== –û—Å—Ç–∞–Ω–Ω—ñ –ø–æ–¥—ñ—ó ==="
            kubectl get events --sort-by=.metadata.creationTimestamp --field-selector involvedObject.kind=Pod | tail -10
          fi

      - name: –£—Å—É–Ω–µ–Ω–Ω—è –Ω–µ–ø–æ–ª–∞–¥–æ–∫ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è
        if: failure()
        run: |
          echo ""
          echo "=== –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –¥–ª—è —É—Å—É–Ω–µ–Ω–Ω—è –Ω–µ–ø–æ–ª–∞–¥–æ–∫ ==="
          echo ""
          echo "=== –î–µ—Ç–∞–ª—ñ –ø–æ–¥—ñ–≤ ==="
          kubectl describe pods -l app=library-app
          echo ""
          echo "=== –û—Å—Ç–∞–Ω–Ω—ñ –ø–æ–¥—ñ—ó ==="
          kubectl get events --sort-by=.metadata.creationTimestamp | tail -20
          echo ""
          echo "=== –°—Ç–∞—Ç—É—Å —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è ==="
          kubectl describe deployment library-app